#!/usr/bin/env bash

dd if=/dev/zero of=valid.img bs=1M count=5
parted -s --align optimal valid.img --script mklabel gpt
parted -s --align optimal valid.img --script mkpart primary 0% 100%
sudo losetup -fP valid.img
LOOPDEV=$(losetup -j valid.img | cut -d: -f1)
PARTITION1="${LOOPDEV}p1"
sudo mkfs.ext4 $PARTITION1
sudo rm -rf /mnt/valid
sudo mkdir /mnt/valid
sudo mount ${PARTITION1} /mnt/valid
sudo mkdir -p /mnt/valid/flash/boot/
sudo mkdir -p /mnt/valid/nsconfig/
sudo mkdir -p /mnt/valid/netscaler/
sudo cp loader.conf /mnt/valid/flash/boot/
sudo cp ns-14.1-46.50.gz /mnt/valid/flash/boot/
sudo cp ns.conf /mnt/valid/nsconfig/
sudo cp nsversion /mnt/valid/netscaler/
sudo umount /mnt/valid
sudo losetup -d ${LOOPDEV}
sudo rm -rf /mnt/valid *.vmdk
qemu-img convert valid.img -O vmdk valid.vmdk
