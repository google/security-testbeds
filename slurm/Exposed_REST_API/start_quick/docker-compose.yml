---
networks:
  internal:
    driver: bridge
    driver_opts:
        com.docker.network.bridge.enable_ip_masquerade: 'true'
        com.docker.network.bridge.enable_icc: 'true'
    internal: false
    enable_ipv6: true
    ipam:
      config:
        - subnet: "10.11.0.0/16"
        - subnet: "2001:db8:1:1::/64"
volumes:
  root-home:
  home:
  etc-ssh:
  cluster-etc-slurm:
  slurmctld:
  elastic_data01:
  elastic_data02:
  elastic_data03:
  mail:
  auth:
  xdmod:
  src:
  container-shared:
services:
  db:
    image: lanced00m00/sql_server:latest
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_USER=slurm
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=slurm_acct_db
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
    volumes:
      - /dev/log:/dev/log
    hostname: db

    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    networks:
      internal:
        ipv4_address: 10.11.1.3
        ipv6_address: 2001:db8:1:1::1:3
    extra_hosts:
      - "db:10.11.1.3"
      - "db:2001:db8:1:1::1:3"
      - "slurmdbd:10.11.1.2"
      - "slurmdbd:2001:db8:1:1::1:2"
      - "login:10.11.1.5"
      - "login:2001:db8:1:1::1:5"
      - "rest:10.11.1.6"
      - "rest:2001:db8:1:1::1:6"
      - "proxy:10.11.1.7"
      - "proxy:2001:db8:1:1::1:7"
      - "es01:10.11.1.15"
      - "es01:2001:db8:1:1::1:15"
      - "es02:10.11.1.16"
      - "es02:2001:db8:1:1::1:16"
      - "es03:10.11.1.17"
      - "es03:2001:db8:1:1::1:17"
      - "kibana:10.11.1.18"
      - "kibana:2001:db8:1:1::1:18"
      - "influxdb:10.11.1.19"
      - "influxdb:2001:db8:1:1::1:19"
      - "grafana:10.11.1.20"
      - "grafana:2001:db8:1:1::1:20"
      - "open-ondemand:10.11.1.21"
      - "open-ondemand:2001:db8:1:1::1:21"
      - "xdmod:10.11.1.22"
      - "xdmod:2001:db8:1:1::1:22"
      - "mgmtnode:10.11.1.1"
      - "mgmtnode:2001:db8:1:1::1:1"
      - "mgmtnode2:10.11.1.4"
      - "mgmtnode2:2001:db8:1:1::1:4"

  slurmdbd:
    image: lanced00m00/scaleout
    environment:
      - SUBNET="10.11"
      - SUBNET6="10.11"
    hostname: slurmdbd
    networks:
      internal:
        ipv4_address: 10.11.1.2
        ipv6_address: 2001:db8:1:1::1:2
    volumes:
      - root-home:/root
      - cluster-etc-slurm:/etc/slurm
      - mail:/var/spool/mail/
      - src:/usr/local/src/

      - /dev/log:/dev/log
      - /etc/localtime:/etc/localtime:ro
      - /run/
      - /run/lock/
      - /sys/
      - /sys/fs/cgroup/:/sys/fs/cgroup/:ro
      - /sys/fs/cgroup/docker.slice/:/sys/fs/cgroup/docker.slice/:rw
      - /sys/fs/fuse/:/sys/fs/fuse/:rw
      - /tmp/
      - /var/lib/journal


    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    depends_on:
      - "db"
    extra_hosts:
      - "db:10.11.1.3"
      - "db:2001:db8:1:1::1:3"
      - "slurmdbd:10.11.1.2"
      - "slurmdbd:2001:db8:1:1::1:2"
      - "login:10.11.1.5"
      - "login:2001:db8:1:1::1:5"
      - "rest:10.11.1.6"
      - "rest:2001:db8:1:1::1:6"
      - "proxy:10.11.1.7"
      - "proxy:2001:db8:1:1::1:7"
      - "es01:10.11.1.15"
      - "es01:2001:db8:1:1::1:15"
      - "es02:10.11.1.16"
      - "es02:2001:db8:1:1::1:16"
      - "es03:10.11.1.17"
      - "es03:2001:db8:1:1::1:17"
      - "kibana:10.11.1.18"
      - "kibana:2001:db8:1:1::1:18"
      - "influxdb:10.11.1.19"
      - "influxdb:2001:db8:1:1::1:19"
      - "grafana:10.11.1.20"
      - "grafana:2001:db8:1:1::1:20"
      - "open-ondemand:10.11.1.21"
      - "open-ondemand:2001:db8:1:1::1:21"
      - "xdmod:10.11.1.22"
      - "xdmod:2001:db8:1:1::1:22"
      - "mgmtnode:10.11.1.1"
      - "mgmtnode:2001:db8:1:1::1:1"
      - "mgmtnode2:10.11.1.4"
      - "mgmtnode2:2001:db8:1:1::1:4"

  mgmtnode:
    image: lanced00m00/scaleout
    environment:
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
      - container=docker
      - SLURM_FEDERATION_CLUSTER=cluster
    hostname: mgmtnode
    networks:
      internal:
        ipv4_address: 10.11.1.1
        ipv6_address: 2001:db8:1:1::1:1
    volumes:
      - root-home:/root
      - home:/home/
      - slurmctld:/var/spool/slurm
      - etc-ssh:/etc/ssh
      - cluster-etc-slurm:/etc/slurm
      - mail:/var/spool/mail/
      - auth:/auth/
      - xdmod:/xdmod/
      - src:/usr/local/src/

      - /dev/log:/dev/log
      - /etc/localtime:/etc/localtime:ro
      - /run/
      - /run/lock/
      - /sys/
      - /sys/fs/cgroup/:/sys/fs/cgroup/:ro
      - /sys/fs/cgroup/docker.slice/:/sys/fs/cgroup/docker.slice/:rw
      - /sys/fs/fuse/:/sys/fs/fuse/:rw
      - /tmp/
      - /var/lib/journal



    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    depends_on:
      - "slurmdbd"
    extra_hosts:
      - "db:10.11.1.3"
      - "db:2001:db8:1:1::1:3"
      - "slurmdbd:10.11.1.2"
      - "slurmdbd:2001:db8:1:1::1:2"
      - "login:10.11.1.5"
      - "login:2001:db8:1:1::1:5"
      - "rest:10.11.1.6"
      - "rest:2001:db8:1:1::1:6"
      - "proxy:10.11.1.7"
      - "proxy:2001:db8:1:1::1:7"
      - "es01:10.11.1.15"
      - "es01:2001:db8:1:1::1:15"
      - "es02:10.11.1.16"
      - "es02:2001:db8:1:1::1:16"
      - "es03:10.11.1.17"
      - "es03:2001:db8:1:1::1:17"
      - "kibana:10.11.1.18"
      - "kibana:2001:db8:1:1::1:18"
      - "influxdb:10.11.1.19"
      - "influxdb:2001:db8:1:1::1:19"
      - "grafana:10.11.1.20"
      - "grafana:2001:db8:1:1::1:20"
      - "open-ondemand:10.11.1.21"
      - "open-ondemand:2001:db8:1:1::1:21"
      - "xdmod:10.11.1.22"
      - "xdmod:2001:db8:1:1::1:22"
      - "mgmtnode:10.11.1.1"
      - "mgmtnode:2001:db8:1:1::1:1"
      - "mgmtnode2:10.11.1.4"
      - "mgmtnode2:2001:db8:1:1::1:4"

  mgmtnode2:
    image: lanced00m00/scaleout
    environment:
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
      - container=docker
      - SLURM_FEDERATION_CLUSTER=cluster
    hostname: mgmtnode2
    networks:
      internal:
        ipv4_address: 10.11.1.4
        ipv6_address: 2001:db8:1:1::1:4
    volumes:
      - root-home:/root
      - etc-ssh:/etc/ssh
      - cluster-etc-slurm:/etc/slurm
      - home:/home/
      - slurmctld:/var/spool/slurm
      - mail:/var/spool/mail/
      - src:/usr/local/src/

      - /dev/log:/dev/log
      - /etc/localtime:/etc/localtime:ro
      - /run/
      - /run/lock/
      - /sys/
      - /sys/fs/cgroup/:/sys/fs/cgroup/:ro
      - /sys/fs/cgroup/docker.slice/:/sys/fs/cgroup/docker.slice/:rw
      - /sys/fs/fuse/:/sys/fs/fuse/:rw
      - /tmp/
      - /var/lib/journal



    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    depends_on:
      - "slurmdbd"
      - "mgmtnode"
    extra_hosts:
      - "db:10.11.1.3"
      - "db:2001:db8:1:1::1:3"
      - "slurmdbd:10.11.1.2"
      - "slurmdbd:2001:db8:1:1::1:2"
      - "login:10.11.1.5"
      - "login:2001:db8:1:1::1:5"
      - "rest:10.11.1.6"
      - "rest:2001:db8:1:1::1:6"
      - "proxy:10.11.1.7"
      - "proxy:2001:db8:1:1::1:7"
      - "es01:10.11.1.15"
      - "es01:2001:db8:1:1::1:15"
      - "es02:10.11.1.16"
      - "es02:2001:db8:1:1::1:16"
      - "es03:10.11.1.17"
      - "es03:2001:db8:1:1::1:17"
      - "kibana:10.11.1.18"
      - "kibana:2001:db8:1:1::1:18"
      - "influxdb:10.11.1.19"
      - "influxdb:2001:db8:1:1::1:19"
      - "grafana:10.11.1.20"
      - "grafana:2001:db8:1:1::1:20"
      - "open-ondemand:10.11.1.21"
      - "open-ondemand:2001:db8:1:1::1:21"
      - "xdmod:10.11.1.22"
      - "xdmod:2001:db8:1:1::1:22"
      - "mgmtnode:10.11.1.1"
      - "mgmtnode:2001:db8:1:1::1:1"
      - "mgmtnode2:10.11.1.4"
      - "mgmtnode2:2001:db8:1:1::1:4"

  login:
    image: lanced00m00/scaleout
    environment:
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
      - container=docker
    hostname: login
    networks:
      internal:
        ipv4_address: 10.11.1.5
        ipv6_address: 2001:db8:1:1::1:5
    volumes:
      - root-home:/root
      - etc-ssh:/etc/ssh
      - cluster-etc-slurm:/etc/slurm
      - home:/home/
      - slurmctld:/var/spool/slurm
      - mail:/var/spool/mail/
      - src:/usr/local/src/
      - /var/lib/containers
      - /dev/fuse:/dev/fuse:rw
      - container-shared:/srv/containers

      - /dev/log:/dev/log
      - /etc/localtime:/etc/localtime:ro
      - /run/
      - /run/lock/
      - /sys/
      - /sys/fs/cgroup/:/sys/fs/cgroup/:ro
      - /sys/fs/cgroup/docker.slice/:/sys/fs/cgroup/docker.slice/:rw
      - /sys/fs/fuse/:/sys/fs/fuse/:rw
      - /tmp/
      - /var/lib/journal


    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    extra_hosts:
      - "db:10.11.1.3"
      - "db:2001:db8:1:1::1:3"
      - "slurmdbd:10.11.1.2"
      - "slurmdbd:2001:db8:1:1::1:2"
      - "login:10.11.1.5"
      - "login:2001:db8:1:1::1:5"
      - "rest:10.11.1.6"
      - "rest:2001:db8:1:1::1:6"
      - "proxy:10.11.1.7"
      - "proxy:2001:db8:1:1::1:7"
      - "es01:10.11.1.15"
      - "es01:2001:db8:1:1::1:15"
      - "es02:10.11.1.16"
      - "es02:2001:db8:1:1::1:16"
      - "es03:10.11.1.17"
      - "es03:2001:db8:1:1::1:17"
      - "kibana:10.11.1.18"
      - "kibana:2001:db8:1:1::1:18"
      - "influxdb:10.11.1.19"
      - "influxdb:2001:db8:1:1::1:19"
      - "grafana:10.11.1.20"
      - "grafana:2001:db8:1:1::1:20"
      - "open-ondemand:10.11.1.21"
      - "open-ondemand:2001:db8:1:1::1:21"
      - "xdmod:10.11.1.22"
      - "xdmod:2001:db8:1:1::1:22"
      - "mgmtnode:10.11.1.1"
      - "mgmtnode:2001:db8:1:1::1:1"
      - "mgmtnode2:10.11.1.4"
      - "mgmtnode2:2001:db8:1:1::1:4"

  node01:
    image: lanced00m00/scaleout
    environment:
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
      - container=docker
      - SLURM_FEDERATION_CLUSTER=cluster
    hostname: node01
    networks:
      internal:
        ipv4_address: 10.11.5.11
        ipv6_address: 2001:db8:1:1::5:11
    volumes:
      - root-home:/root
      - etc-ssh:/etc/ssh
      - cluster-etc-slurm:/etc/slurm
      - home:/home/
      - mail:/var/spool/mail/
      - src:/usr/local/src/
      - container-shared:/srv/containers

      - /dev/log:/dev/log
      - /etc/localtime:/etc/localtime:ro
      - /run/
      - /run/lock/
      - /sys/
      - /sys/fs/cgroup/:/sys/fs/cgroup/:ro
      - /sys/fs/cgroup/docker.slice/:/sys/fs/cgroup/docker.slice/:rw
      - /sys/fs/fuse/:/sys/fs/fuse/:rw
      - /tmp/
      - /var/lib/journal

    ulimits:
      nproc:
        soft: 65535
        hard: 65535
      nofile:
        soft: 131072
        hard: 131072
      memlock:
        soft: -1
        hard: -1

    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    depends_on:
      - "mgmtnode"
    extra_hosts:
      - "db:10.11.1.3"
      - "db:2001:db8:1:1::1:3"
      - "slurmdbd:10.11.1.2"
      - "slurmdbd:2001:db8:1:1::1:2"
      - "login:10.11.1.5"
      - "login:2001:db8:1:1::1:5"
      - "rest:10.11.1.6"
      - "rest:2001:db8:1:1::1:6"
      - "proxy:10.11.1.7"
      - "proxy:2001:db8:1:1::1:7"
      - "es01:10.11.1.15"
      - "es01:2001:db8:1:1::1:15"
      - "es02:10.11.1.16"
      - "es02:2001:db8:1:1::1:16"
      - "es03:10.11.1.17"
      - "es03:2001:db8:1:1::1:17"
      - "kibana:10.11.1.18"
      - "kibana:2001:db8:1:1::1:18"
      - "influxdb:10.11.1.19"
      - "influxdb:2001:db8:1:1::1:19"
      - "grafana:10.11.1.20"
      - "grafana:2001:db8:1:1::1:20"
      - "open-ondemand:10.11.1.21"
      - "open-ondemand:2001:db8:1:1::1:21"
      - "xdmod:10.11.1.22"
      - "xdmod:2001:db8:1:1::1:22"
      - "mgmtnode:10.11.1.1"
      - "mgmtnode:2001:db8:1:1::1:1"
      - "mgmtnode2:10.11.1.4"
      - "mgmtnode2:2001:db8:1:1::1:4"

  open-ondemand:
    image: lanced00m00/open-ondemand:latest
    environment:
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
      - DEFAULT_SSHHOST=login
    volumes:
      - /dev/log:/dev/log
      - etc-ssh:/etc/shared-ssh
      - home:/home/
    networks:
      internal:
        ipv4_address: 10.11.1.21
        ipv6_address: 2001:db8:1:1::1:21
    depends_on:
      - "login"

    ports:
      - 8081:80


    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

  influxdb:
    image: lanced00m00/influxdb:latest
    command: ["bash", "-c", "/setup.sh & source /entrypoint.sh"]
    environment:
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=user
      - DOCKER_INFLUXDB_INIT_PASSWORD=password
      - DOCKER_INFLUXDB_INIT_ORG=scaleout
      - DOCKER_INFLUXDB_INIT_BUCKET=scaleout
      - DOCKER_INFLUXDB_INIT_RETENTION=1w
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=token
      - DOCKER_INFLUXDB_INIT_USER_ID=
      - INFLUXDB_DATA_QUERY_LOG_ENABLED=true
      - INFLUXDB_REPORTING_DISABLED=false
      - INFLUXDB_HTTP_LOG_ENABLED=true
      - INFLUXDB_CONTINUOUS_QUERIES_LOG_ENABLED=true
      - LOG_LEVEL=debug
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - /dev/log:/dev/log
    networks:
      internal:
        ipv4_address: 10.11.1.19
        ipv6_address: 2001:db8:1:1::1:19

    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

  grafana:
    image: lanced00m00/grafana:latest
    environment:
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
    volumes:
      - /dev/log:/dev/log
    networks:
      internal:
        ipv4_address: 10.11.1.20
        ipv6_address: 2001:db8:1:1::1:20

    ports:
      - 3000:3000


    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

  es01:
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:7.10.1
    environment:
      - node.name=es01
      - cluster.name=scaleout
      - discovery.seed_hosts=es02,es03
      - cluster.initial_master_nodes=es01,es02,es03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elastic_data01:/usr/share/elasticsearch/data
      - /dev/log:/dev/log
    networks:
      internal:
        ipv4_address: 10.11.1.15
        ipv6_address: 2001:db8:1:1::1:15

    ports:
      - 9200:9200


    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

  es02:
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:7.10.1
    environment:
      - node.name=es02
      - cluster.name=scaleout
      - discovery.seed_hosts=es01,es03
      - cluster.initial_master_nodes=es01,es02,es03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elastic_data02:/usr/share/elasticsearch/data
      - /dev/log:/dev/log
    networks:
      internal:
        ipv4_address: 10.11.1.16
        ipv6_address: 2001:db8:1:1::1:16

    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

  es03:
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:7.10.1
    environment:
      - node.name=es03
      - cluster.name=scaleout
      - discovery.seed_hosts=es01,es02
      - cluster.initial_master_nodes=es01,es02,es03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elastic_data03:/usr/share/elasticsearch/data
      - /dev/log:/dev/log
    networks:
      internal:
        ipv4_address: 10.11.1.17
        ipv6_address: 2001:db8:1:1::1:17

    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

  kibana:
    image: docker.elastic.co/kibana/kibana-oss:7.10.1
    volumes:
      - /dev/log:/dev/log
    environment:
      - SERVER_NAME=scaleout
      - ELASTICSEARCH_HOSTS=http://es01:9200
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
    networks:
      internal:
        ipv4_address: 10.11.1.18
        ipv6_address: 2001:db8:1:1::1:18

    ports:
      - 5601:5601

    depends_on:
      - "es01"
      - "es02"
      - "es03"

    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

  rest:
    hostname: rest
    image: lanced00m00/scaleout
    networks:
      internal:
        ipv4_address: 10.11.1.6
        ipv6_address: 2001:db8:1:1::1:6
    volumes:
      - etc-ssh:/etc/ssh
      - cluster-etc-slurm:/etc/slurm

      - /dev/log:/dev/log
      - /etc/localtime:/etc/localtime:ro
      - /run/
      - /run/lock/
      - /sys/
      - /sys/fs/cgroup/:/sys/fs/cgroup/:ro
      - /sys/fs/cgroup/docker.slice/:/sys/fs/cgroup/docker.slice/:rw
      - /sys/fs/fuse/:/sys/fs/fuse/:rw
      - /tmp/
      - /var/lib/journal


    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    depends_on:
      - "mgmtnode"
    extra_hosts:
      - "db:10.11.1.3"
      - "db:2001:db8:1:1::1:3"
      - "slurmdbd:10.11.1.2"
      - "slurmdbd:2001:db8:1:1::1:2"
      - "login:10.11.1.5"
      - "login:2001:db8:1:1::1:5"
      - "rest:10.11.1.6"
      - "rest:2001:db8:1:1::1:6"
      - "proxy:10.11.1.7"
      - "proxy:2001:db8:1:1::1:7"
      - "es01:10.11.1.15"
      - "es01:2001:db8:1:1::1:15"
      - "es02:10.11.1.16"
      - "es02:2001:db8:1:1::1:16"
      - "es03:10.11.1.17"
      - "es03:2001:db8:1:1::1:17"
      - "kibana:10.11.1.18"
      - "kibana:2001:db8:1:1::1:18"
      - "influxdb:10.11.1.19"
      - "influxdb:2001:db8:1:1::1:19"
      - "grafana:10.11.1.20"
      - "grafana:2001:db8:1:1::1:20"
      - "open-ondemand:10.11.1.21"
      - "open-ondemand:2001:db8:1:1::1:21"
      - "xdmod:10.11.1.22"
      - "xdmod:2001:db8:1:1::1:22"
      - "mgmtnode:10.11.1.1"
      - "mgmtnode:2001:db8:1:1::1:1"
      - "mgmtnode2:10.11.1.4"
      - "mgmtnode2:2001:db8:1:1::1:4"

  proxy:
    image: lanced00m00/proxy:latest
    environment:
      - SUBNET="10.11"
      - SUBNET6="2001:db8:1:1::"
      - container=docker
    hostname: proxy
    command: ["bash", "-c", "/usr/sbin/nginx& /usr/sbin/php-fpm83 -F& wait"]
    networks:
      internal:
        ipv4_address: 10.11.1.7
        ipv6_address: 2001:db8:1:1::1:7
    volumes:
      - auth:/auth/
      - /dev/log:/dev/log

    tty: true
    logging:
      driver: local
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined


    ports:
      - 8080:8080

    depends_on:
      - "rest"
    extra_hosts:
      - "db:10.11.1.3"
      - "db:2001:db8:1:1::1:3"
      - "slurmdbd:10.11.1.2"
      - "slurmdbd:2001:db8:1:1::1:2"
      - "login:10.11.1.5"
      - "login:2001:db8:1:1::1:5"
      - "rest:10.11.1.6"
      - "rest:2001:db8:1:1::1:6"
      - "proxy:10.11.1.7"
      - "proxy:2001:db8:1:1::1:7"
      - "es01:10.11.1.15"
      - "es01:2001:db8:1:1::1:15"
      - "es02:10.11.1.16"
      - "es02:2001:db8:1:1::1:16"
      - "es03:10.11.1.17"
      - "es03:2001:db8:1:1::1:17"
      - "kibana:10.11.1.18"
      - "kibana:2001:db8:1:1::1:18"
      - "influxdb:10.11.1.19"
      - "influxdb:2001:db8:1:1::1:19"
      - "grafana:10.11.1.20"
      - "grafana:2001:db8:1:1::1:20"
      - "open-ondemand:10.11.1.21"
      - "open-ondemand:2001:db8:1:1::1:21"
      - "xdmod:10.11.1.22"
      - "xdmod:2001:db8:1:1::1:22"
      - "mgmtnode:10.11.1.1"
      - "mgmtnode:2001:db8:1:1::1:1"
      - "mgmtnode2:10.11.1.4"
      - "mgmtnode2:2001:db8:1:1::1:4"


