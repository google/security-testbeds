# Arguments
ARG JAVA_VERSION=17
ARG XWIKI_VERSION=17.4.3
# Change at build time to 15.10.10 for a vulnerable version

FROM openjdk:${JAVA_VERSION}-jdk-slim

ARG XWIKI_VERSION
ENV XWIKI_DOWNLOAD_URL=https://nexus.xwiki.org/nexus/content/repositories/releases/org/xwiki/platform/xwiki-platform-distribution-jetty-hsqldb/${XWIKI_VERSION}/xwiki-platform-distribution-jetty-hsqldb-${XWIKI_VERSION}.zip

# Creating non-root user for XWiki
RUN useradd -ms /bin/bash xwiki

# Update and install required packages
RUN apt-get update && \
    apt-get install -y wget unzip ca-certificates python3-requests && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /opt
ENV DIR_XWIKI=/opt/xwiki

# Downloading XWiki
RUN wget --quiet --show-progress --tries=3 -O xwiki.zip "${XWIKI_DOWNLOAD_URL}" && \
    unzip xwiki.zip && \
    rm xwiki.zip && \
    mv xwiki-platform-distribution-jetty-hsqldb-${XWIKI_VERSION} xwiki && \
    chown -R xwiki:xwiki ${DIR_XWIKI}

# Exposing port 8080 for Jetty
EXPOSE 8080

# Upload init scripts
ENV SCRIPT_INIT=xwiki-init.py
COPY ${SCRIPT_INIT} ${DIR_XWIKI}
RUN chmod +x ${DIR_XWIKI}/${SCRIPT_INIT} && \
    chown xwiki:xwiki ${DIR_XWIKI}/${SCRIPT_INIT}

# permanentDirectory
# ENV DIR_PERMANENT=/var/lib/xwiki/data
ENV DIR_PERMANENT=${DIR_XWIKI}/data
# RUN mkdir -p ${DIR_PERMANENT} && \
#     chown -R xwiki:xwiki ${DIR_PERMANENT}

# If needed to persist data
# VOLUME ["${DIR_PERMANENT}"]

# Using xwiki user now
USER xwiki

# Offline Repository for installing Standard Flavor
ENV DIR_REPOSITORY=${DIR_PERMANENT}/extension/repository
RUN mkdir -p ${DIR_REPOSITORY}
WORKDIR ${DIR_REPOSITORY}

RUN wget --quiet --show-progress --tries=3 -O repository.zip https://nexus.xwiki.org/nexus/content/groups/public/org/xwiki/platform/xwiki-platform-distribution-flavor-xip/${XWIKI_VERSION}/xwiki-platform-distribution-flavor-xip-${XWIKI_VERSION}.xip && \
    unzip repository.zip && \
    rm repository.zip


WORKDIR ${DIR_XWIKI}

# Starting Jetty + XWiki
# CMD ["./start_xwiki.sh"]

# Automating the installation process
CMD ["/bin/bash", "-c", "/usr/bin/python3 ${DIR_XWIKI}/${SCRIPT_INIT}"]
