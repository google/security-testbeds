FROM openjdk:8-jre-slim

ARG CONFIG
ENV CONFIG=${CONFIG}

# setenv
ENV CATALINA_HOME=/usr/local/tomcat
ENV PATH=$CATALINA_HOME/bin:$PATH
ENV TOMCAT_VERSION=8.5.16

RUN mkdir -p $CATALINA_HOME

# download Apache Tomcat 8.5.16
RUN apt-get update && apt-get install -y curl && \
    curl -fSL "https://archive.apache.org/dist/tomcat/tomcat-8/v${TOMCAT_VERSION}/bin/apache-tomcat-${TOMCAT_VERSION}.tar.gz" -o /tmp/tomcat.tar.gz && \
    tar -xvf /tmp/tomcat.tar.gz -C ${CATALINA_HOME} --strip-components=1

# set perms
RUN chmod +x $CATALINA_HOME/bin/*.sh

# depending on CONFIG, we might have vulnerable or not vulnerable testbed
COPY ./web.xml ${CATALINA_HOME}/conf/web.xml
RUN if [ "$CONFIG" = "vuln" ]; then \
    sed -i 's/<param-name>readonly<\/param-name><param-value>true<\/param-value>/<param-name>readonly<\/param-name><param-value>false<\/param-value>/' \
    /usr/local/tomcat/conf/web.xml; \
    fi;

EXPOSE 8080

CMD ["catalina.sh", "run"]
