#!/usr/bin/env bash
# wingftp_autosetup.sh - Minimal auto setup: start WingFTP, create domain+user
# Testbed for WingFTP CVE-2025-47812
set -euo pipefail

ADMIN="administrator"
PASS="wingftp"
PORT="5466"
HOST="127.0.0.1:5466"
BASE_URL="http://127.0.0.1:5466"
WING_HOME="$(dirname "$(readlink -f "$0")")"
ADMIN_DIR="$WING_HOME/Data/_ADMINISTRATOR"

# --- Setup admin XML ---
mkdir -p "$ADMIN_DIR"
MD5=$(echo -n "$PASS" | md5sum | awk '{print $1}')
cat >"$ADMIN_DIR/admins.xml" <<EOF
<ADMIN_ACCOUNTS><ADMIN><Admin_Name>$ADMIN</Admin_Name><Password>$MD5</Password><Type>0</Type></ADMIN></ADMIN_ACCOUNTS>
EOF
cat >"$ADMIN_DIR/settings.xml" <<EOF
<Administrator><HttpPort>$PORT</HttpPort><HttpSecure>0</HttpSecure></Administrator>
EOF

# --- Start server in background for setup ---
"$WING_HOME/wftpserver" >/dev/null 2>&1 &
SERVER_PID=$!
echo "WingFTP server started with PID: $SERVER_PID"



# Wait for server to be ready
echo "Waiting for server to initialize..."
sleep 5

# Test if server is responding
for i in {1..10}; do
    if curl -s -f "$BASE_URL/admin_login.html" >/dev/null 2>&1; then
        echo "Server is ready!"
        break
    fi
    echo "Waiting for server... ($i/10)"
    sleep 2
done

# Login and grab UIDADMIN cookie
echo "Performing login..."
LOGIN_RESP=$(curl --path-as-is -i -s -k -X 'POST' \
  -H "Host: ${HOST}" \
  -H 'Content-Length: 87' \
  -H 'Cache-Control: max-age=0' \
  -H "Origin: ${BASE_URL}" \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -H 'Upgrade-Insecure-Requests: 1' \
  -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36' \
  -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8' \
  -H 'Sec-GPC: 1' \
  -H 'Accept-Language: en-US,en;q=0.6' \
  -H "Referer: ${BASE_URL}/admin_login.html" \
  -H 'Accept-Encoding: gzip, deflate, br' \
  -H 'Connection: keep-alive' \
  -b 'admin_lang=english' \
  --data-binary "username=${ADMIN}&password=${PASS}&username_val=${ADMIN}&password_val=${PASS}" \
  "$BASE_URL/admin_loginok.html")

UIDADMIN=$(echo "$LOGIN_RESP" | grep -i '^Set-Cookie:' | grep -o 'UIDADMIN=[^;]*' | head -n1 | cut -d'=' -f2)
if [[ -z "$UIDADMIN" ]]; then
    echo "Login failed - server may not be ready"
    echo "Server PID: $SERVER_PID"
    ps aux | grep wftpserver || true
    exit 1
fi

echo "Login successful, creating domain and user..."
COOKIE="admin_lang=english; UIDADMIN=$UIDADMIN"

# Create domain 
curl --path-as-is -i -s -k -X 'POST' \
  -H "Host: ${HOST}" \
  -H 'Content-Length: 90' \
  -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -H 'Accept: */*' \
  -H 'Sec-GPC: 1' \
  -H 'Accept-Language: en-US,en;q=0.6' \
  -H "Origin: ${BASE_URL}" \
  -H "Referer: ${BASE_URL}/main.html?lang=english" \
  -H 'Accept-Encoding: gzip, deflate, br' \
  -H 'Connection: keep-alive' \
  -b "$COOKIE" \
  --data-binary 'domain=poc&bindaddress=*&ftp_port=-1&ftps_port=-1&http_port=5467&https_port=-1&ssh_port=-1' \
  "$BASE_URL/admin_create_domain.html" > /dev/null

# Create anonymous user in the new domain
curl --path-as-is -i -s -k -X 'POST' \
  -H "Host: ${HOST}" \
  -H 'Content-Length: 1623' \
  -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -H 'Accept: */*' \
  -H 'Sec-GPC: 1' \
  -H 'Accept-Language: en-US,en;q=0.6' \
  -H "Origin: ${BASE_URL}" \
  -H "Referer: ${BASE_URL}/admin_adduser_form.html?domain=poc&seeds=0.009813035357509325" \
  -H 'Accept-Encoding: gzip, deflate, br' \
  -H 'Connection: keep-alive' \
  -b "$COOKIE" \
  --data-binary $'domain=poc&user=%7B%22username%22%3A%22anonymous%22%2C%22password%22%3A%22%22%2C%22max_download%22%3A%220%22%2C%22max_upload%22%3A%220%22%2C%22max_download_account%22%3A%220%22%2C%22max_upload_account%22%3A%220%22%2C%22max_connection%22%3A%220%22%2C%22connect_timeout%22%3A%225%22%2C%22idle_timeout%22%3A%225%22%2C%22connect_per_ip%22%3A%220%22%2C%22pass_length%22%3A%220%22%2C%22show_hidden_file%22%3A0%2C%22change_pass%22%3A0%2C%22send_message%22%3A0%2C%22ratio_credit%22%3A%220%22%2C%22ratio_download%22%3A%221%22%2C%22ratio_upload%22%3A%221%22%2C%22ratio_count_method%22%3A0%2C%22enable_ratio%22%3A0%2C%22current_quota%22%3A%220%22%2C%22max_quota%22%3A%220%22%2C%22enable_quota%22%3A0%2C%22note_name%22%3A%22%22%2C%22note_address%22%3A%22%22%2C%22note_zip%22%3A%22%22%2C%22note_phone%22%3A%22%22%2C%22note_fax%22%3A%22%22%2C%22note_email%22%3A%22%22%2C%22note_memo%22%3A%22%22%2C%22ipmasks%22%3A%5B%5D%2C%22filemasks%22%3A%5B%5D%2C%22directories%22%3A%5B%5D%2C%22usergroups%22%3A%5B%5D%2C%22schedules%22%3A%5B%5D%2C%22subdir_perm%22%3A%5B%5D%2C%22enable_schedule%22%3A0%2C%22limit_reset_type%22%3A%220%22%2C%22limit_enable_upload%22%3A0%2C%22cur_upload_size%22%3A%220%22%2C%22max_upload_size%22%3A%220%22%2C%22limit_enable_download%22%3A0%2C%22cur_download_size%22%3A%220%22%2C%22max_download_size%22%3A%220%22%2C%22enable_expire%22%3A0%2C%22expiretime%22%3A%22%22%2C%22protocol_type%22%3A63%2C%22enable_password%22%3A0%2C%22enable_account%22%3A1%2C%22ssh_pubkey_path%22%3A%22%22%2C%22enable_ssh_pubkey_auth%22%3A0%2C%22ssh_auth_method%22%3A0%2C%22enable_weblink%22%3A1%2C%22enable_uplink%22%3A1%7D&r=0.6865473607034562' \
  "${BASE_URL}/admin_adduser.html" > /dev/null

echo "WingFTP automation complete"
\echo "Admin interface: http://127.0.0.1:5466"
echo "Domain server: http://127.0.0.1:5467"

# Keep container alive
while true; do sleep 3600; done