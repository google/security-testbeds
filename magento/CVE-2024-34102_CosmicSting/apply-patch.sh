#!/bin/bash

echo "==== Patching Magento against CosmicSting XXE (CVE-2024-34102)"
echo "Installing tools needed to apply patch"
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get install -y wget unzip patch

echo "Downloading patch from Adobe's website"
cd /opt/bitnami/magento
wget "https://experienceleague.adobe.com/docs/commerce-knowledge-base/assets/VULN-27015-2.4.7x_v2_COMPOSER_patch.zip"
unzip -o VULN-27015-2.4.7x_v2_COMPOSER_patch.zip

echo "Applying patch"
patch -p1 < VULN-27015-2.4.7x_v2.composer.patch

echo "==== Patching done. Starting Magento now. ===="
/opt/bitnami/scripts/magento/entrypoint.sh /opt/bitnami/scripts/magento/run.sh